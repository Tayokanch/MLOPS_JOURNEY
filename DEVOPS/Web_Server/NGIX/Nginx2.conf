# Define a group of backend servers (upstream) for load balancing
upstream express_backend {
    server container1:3000;   # Backend container 1, port 3000
    server container2:3000;   # Backend container 2, port 3000
    server container3:3000;   # Backend container 3, port 3000
    server container4:3000;   # Backend container 4, port 3000
}

# Define the server block (listens for incoming requests)

server {
    listen 80;
    server_name example.com;

    # Return a 403 Forbidden for all HTTP requests
    return 403;
}

server {
    listen 80;
    server_name example.com;

    # Redirect all HTTP requests to HTTPS
    return 301 https://$host$request_uri;
}


server {
    listen 443 ssl;            # Listen on port 443 for HTTPS traffic
    server_name example.com;   # The domain name this server responds to

    # SSL certificate and key for HTTPS
    ssl_certificate /etc/ssl/certs/example.com.crt;      # Path to SSL certificate file
    ssl_certificate_key /etc/ssl/private/example.com.key; # Path to SSL private key

    # Define routing for all requests to the root path "/"
    location / {
        proxy_pass http://express_backend;  # Forward requests to the upstream backend group

        # Preserve client request information and headers
        proxy_set_header Host $host;                  # Forward the original Host header
        proxy_set_header X-Real-IP $remote_addr;      # Forward the client IP address
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Add client IP to the X-Forwarded-For chain
        proxy_set_header X-Forwarded-Proto $scheme;  # Forward the original protocol (HTTP/HTTPS)
    }
}
